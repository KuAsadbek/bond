<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-ru="Настройки | Bond and Data" data-uz="Sozlamalar | Bond and Data">Настройки | Bond and Data</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #6366f1;
            --bg-dark: #0f172a;
            --text-main: #f8fafc;
            --glass: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --neon-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Background Elements */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            pointer-events: none;
        }

        .radial-glow {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-30%, -30%);
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
            z-index: -1;
            pointer-events: none;
        }

        /* Navigation */
        header {
            padding: 20px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-box {
            width: 45px;
            height: 45px;
            background: var(--secondary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 24px;
            color: white;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-text .main {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 20px;
            letter-spacing: 2px;
            color: white;
        }

        .logo-text .sub {
            font-size: 10px;
            letter-spacing: 4px;
            color: var(--primary);
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .lang-switcher {
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
        }

        .lang-btn {
            padding: 6px 15px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.5);
        }

        .lang-btn.active {
            background: var(--primary);
            color: var(--bg-dark);
            box-shadow: var(--neon-shadow);
        }

        .lang-divider {
            color: rgba(255, 255, 255, 0.2);
            margin: 0 5px;
            font-size: 10px;
        }

        .btn-back {
            background: var(--secondary);
            color: white;
            text-decoration: none;
            padding: 10px 25px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            letter-spacing: 1px;
            transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }

        /* Main Content */
        .settings-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
            flex: 1;
        }

        .page-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .page-header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            letter-spacing: 3px;
            color: white;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .page-header p {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }

        .section-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .section-title i {
            font-size: 20px;
            color: var(--primary);
            text-shadow: var(--neon-shadow);
        }

        .section-title h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            letter-spacing: 1px;
            color: white;
            text-transform: uppercase;
        }

        /* Info Rows */
        .info-grid {
            display: grid;
            gap: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            transition: all 0.3s;
        }

        .info-row:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .info-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            color: white;
            font-size: 15px;
            font-weight: 600;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 15px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.1);
            color: #81c784;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.1);
            color: #ffd54f;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
        }

        .form-input {
            width: 100%;
            padding: 15px 15px 15px 45px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 242, 255, 0.05);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.1);
        }

        .form-input:focus+i {
            color: var(--primary);
        }

        .phone-input-group {
            display: flex;
            gap: 10px;
        }

        .phone-prefix {
            padding: 15px 15px;
            background: rgba(0, 242, 255, 0.1);
            border: 1px solid rgba(0, 242, 255, 0.2);
            border-radius: 12px;
            color: var(--primary);
            font-weight: 700;
            font-size: 14px;
        }

        .phone-input-group .form-input {
            padding-left: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--secondary) 0%, #4f46e5 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
        }

        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-verify {
            background: linear-gradient(135deg, var(--primary) 0%, #00d2ff 100%);
            color: var(--bg-dark);
            box-shadow: 0 4px 15px rgba(0, 242, 255, 0.3);
        }

        .btn-verify:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(0, 242, 255, 0.5);
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 12px;
            font-size: 13px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-success {
            background: rgba(76, 175, 80, 0.1);
            color: #81c784;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .message-error {
            background: rgba(244, 67, 54, 0.1);
            color: #ef9a9a;
            border: 1px solid rgba(244, 67, 54, 0.2);
        }

        #phoneTimer {
            text-align: center;
            font-size: 12px;
            color: var(--primary);
            margin-top: 10px;
            font-weight: 600;
        }

        footer {
            padding: 40px 5%;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(15, 23, 42, 0.3);
        }

        .copyright {
            color: rgba(255, 255, 255, 0.3);
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .page-header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>

<body>
    {% load static %}
    <canvas id="bg-canvas"></canvas>
    <div class="grid-overlay"></div>
    <div class="radial-glow"></div>

    <header>
        <a href="/" class="logo">
            <div class="logo-box">B</div>
            <div class="logo-text">
                <span class="main">BOND</span>
                <span class="sub">OLYMPIAD</span>
            </div>
        </a>

        <div class="header-actions">
            <div class="lang-switcher">
                <span class="lang-btn active" data-lang="uz">UZ</span>
                <span class="lang-divider">|</span>
                <span class="lang-btn" data-lang="ru">RU</span>
            </div>
            <a href="{% url 'public:profile' %}" class="btn-back" data-ru="НАЗАД" data-uz="ORQAGA">ORQAGA</a>
        </div>
    </header>

    <div class="settings-container">
        <div class="page-header">
            <h1 data-ru="НАСТРОЙКИ" data-uz="SOZLAMALAR">SOZLAMALAR</h1>
            <p data-ru="Управляйте вашим аккаунтом и личными данными"
                data-uz="Hisobingiz va shaxsiy ma'lumotlaringizni boshqaring">Hisobingiz va shaxsiy ma'lumotlaringizni
                boshqaring</p>
        </div>

        <!-- Personal Info -->
        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-id-card"></i>
                <h2 data-ru="ЛИЧНЫЕ ДАННЫЕ" data-uz="SHAXSIY MA'LUMOTLAR">SHAXSIY MA'LUMOTLAR</h2>
            </div>
            <div class="info-grid">
                <div class="info-row">
                    <span class="info-label" data-ru="ФИО" data-uz="F.I.O">F.I.O</span>
                    <span class="info-value">{{ participant.fullname }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label" data-ru="ТЕЛЕФОН" data-uz="TELEFON">TELEFON</span>
                    <span class="info-value">{{ participant.phone_number }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label" data-ru="РЕГИОН" data-uz="VILOYAT">VILOYAT</span>
                    <span class="info-value">{{ participant.region }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label" data-ru="РАЙОН" data-uz="TUMAN">TUMAN</span>
                    <span class="info-value">{{ participant.district }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label" data-ru="ШКОЛА" data-uz="MAKTAB">MAKTAB</span>
                    <span class="info-value">{{ participant.school }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label" data-ru="КЛАСС" data-uz="SINF">SINF</span>
                    <span class="info-value">{{ participant.grade }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label" data-ru="УЧИТЕЛЬ" data-uz="O'QITUVCHI">O'QITUVCHI</span>
                    <span class="info-value">{{ participant.teacher_fullname }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label" data-ru="СТАТУС" data-uz="HOLAT">HOLAT</span>
                    <span class="info-value">
                        {% if participant.is_checked_in %}
                        <span class="status-badge status-success">
                            <i class="fas fa-check-circle"></i>
                            <span data-ru="ОТМЕЧЕН" data-uz="BELGILANGAN">BELGILANGAN</span>
                        </span>
                        {% else %}
                        <span class="status-badge status-pending">
                            <i class="fas fa-clock"></i>
                            <span data-ru="ОЖИДАЕТСЯ" data-uz="KUTILMOQDA">KUTILMOQDA</span>
                        </span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Phone Verification -->
        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-mobile-alt"></i>
                <h2 data-ru="ПОДТВЕРЖДЕНИЕ ТЕЛЕФОНА" data-uz="TELEFONNI TASDIQLASH">TELEFONNI TASDIQLASH</h2>
            </div>

            {% if participant.telegram_user_id %}
            <div class="message message-success">
                <i class="fas fa-shield-alt"></i>
                <span data-ru="Ваш номер телефона успешно подтверждён через Telegram."
                    data-uz="Telefon raqamingiz Telegram orqali muvaffaqiyatli tasdiqlangan.">Telefon raqamingiz
                    Telegram orqali muvaffaqiyatli tasdiqlangan.</span>
            </div>
            {% else %}
            <div id="phoneVerifySection">
                <div class="form-group">
                    <label class="form-label" data-ru="ТЕКУЩИЙ НОМЕР" data-uz="JORIY RAQAM">JORIY RAQAM</label>
                    <div class="phone-input-group">
                        <span class="phone-prefix">+998</span>
                        <input type="text" class="form-input" value="{{ participant.phone_number|slice:'4:' }}" readonly
                            style="padding-left: 15px;">
                    </div>
                </div>
                <button class="btn-submit btn-verify" onclick="sendPhoneCode()" id="sendPhoneCodeBtn">
                    <i class="fas fa-paper-plane"></i>
                    <span data-ru="ОТПРАВИТЬ КОД" data-uz="KOD YUBORISH">KOD YUBORISH</span>
                </button>

                <div id="phoneCodeSection" style="display: none; margin-top: 25px;">
                    <div class="form-group">
                        <label class="form-label" data-ru="КОД ИЗ SMS" data-uz="SMS KODI">КОД ИЗ SMS</label>
                        <div class="input-wrapper">
                            <input type="text" id="phone_code" class="form-input" placeholder="000000" maxlength="6">
                            <i class="fas fa-key"></i>
                        </div>
                    </div>
                    <button class="btn-submit" onclick="verifyPhoneCode()" id="verifyPhoneCodeBtn">
                        <i class="fas fa-check-double"></i>
                        <span data-ru="ПОДТВЕРДИТЬ" data-uz="TASDIQLASH">TASDIQLASH</span>
                    </button>
                    <div id="phoneTimer"></div>
                </div>
                <div id="phoneMessage" style="margin-top: 20px;"></div>
            </div>
            {% endif %}
        </div>

        <!-- Change Password -->
        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-lock"></i>
                <h2 data-ru="ИЗМЕНИТЬ ПАРОЛЬ" data-uz="PAROLNI O'ZGARTIRISH">PAROLNI O'ZGARTIRISH</h2>
            </div>
            <form id="changePasswordForm">
                {% csrf_token %}
                <div class="form-group">
                    <label class="form-label" data-ru="ТЕКУЩИЙ ПАРОЛЬ" data-uz="JORIY PAROL">JORIY PAROL</label>
                    <div class="input-wrapper">
                        <input type="password" name="current_password" class="form-input" required>
                        <i class="fas fa-unlock-alt"></i>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-ru="НОВЫЙ ПАРОЛЬ" data-uz="YANGI PAROL">YANGI PAROL</label>
                        <div class="input-wrapper">
                            <input type="password" name="new_password" class="form-input" required>
                            <i class="fas fa-key"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-ru="ПОДТВЕРДИТЕ" data-uz="TASDIQLANG">ПОДТВЕРДИТЕ</label>
                        <div class="input-wrapper">
                            <input type="password" name="confirm_password" class="form-input" required>
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
                <div id="passwordMessage"></div>
                <button type="submit" class="btn-submit">
                    <i class="fas fa-save"></i>
                    <span data-ru="СОХРАНИТЬ ПАРОЛЬ" data-uz="PAROLNI SAQLASH">PAROLNI SAQLASH</span>
                </button>
            </form>
        </div>
    </div>

    <footer>
        <p class="copyright" data-ru="&copy; 2024 BOND Olimpiada. Все права защищены."
            data-uz="&copy; 2024 BOND Olimpiada. Barcha huquqlar himoyalangan.">&copy; 2024 BOND Olimpiada. Barcha
            huquqlar himoyalangan.</p>
    </footer>

    <script>
        // Background Animation
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        window.addEventListener('resize', resize);
        resize();

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;
                this.opacity = Math.random() * 0.5 + 0.2;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                if (this.x > canvas.width) this.x = 0;
                else if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0;
                else if (this.y < 0) this.y = canvas.height;
            }

            draw() {
                ctx.fillStyle = `rgba(0, 242, 255, ${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particles = [];
            for (let i = 0; i < 100; i++) {
                particles.push(new Particle());
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(animate);
        }

        initParticles();
        animate();

        // Language Logic
        const langBtns = document.querySelectorAll('.lang-btn');
        const currentLang = localStorage.getItem('selectedLang') || 'uz';

        function setLanguage(lang) {
            document.querySelectorAll('[data-ru]').forEach(el => {
                const text = el.getAttribute(`data-${lang}`);
                if (text) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = text;
                    } else {
                        // Check if text containing HTML tags (like <span>)
                        if (text.includes('<') && text.includes('>')) {
                            el.innerHTML = text;
                        } else {
                            // Check if element has child elements (like icons)
                            const icon = el.querySelector('i, svg');
                            if (icon) {
                                el.childNodes.forEach(node => {
                                    if (node.nodeType === Node.TEXT_NODE && node.textContent.trim().length > 0) {
                                        node.textContent = ' ' + text + ' ';
                                    }
                                });
                            } else {
                                el.textContent = text;
                            }
                        }
                    }
                }
            });

            langBtns.forEach(btn => {
                if (btn.getAttribute('data-lang') === lang) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            localStorage.setItem('selectedLang', lang);
            document.documentElement.lang = lang;
        }

        langBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                setLanguage(btn.getAttribute('data-lang'));
            });
        });

        // Initialize language
        setLanguage(currentLang);

        // Verification Logic
        let phoneTimerInterval = null;

        async function sendPhoneCode() {
            const btn = document.getElementById('sendPhoneCodeBtn');
            const section = document.getElementById('phoneCodeSection');
            const msg = document.getElementById('phoneMessage');
            const lang = localStorage.getItem('selectedLang') || 'uz';

            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            msg.innerHTML = '';

            try {
                const response = await fetch('{% url "public:send_verification_code" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ phone_number: '{{ participant.phone_number }}' })
                });

                const data = await response.json();

                if (data.success) {
                    msg.innerHTML = `<div class="message message-success"><i class="fas fa-check-circle"></i> ${lang === 'uz' ? 'Kod yuborildi!' : 'Код отправлен!'}</div>`;
                    section.style.display = 'block';
                    startPhoneTimer(60);
                } else {
                    msg.innerHTML = `<div class="message message-error"><i class="fas fa-exclamation-triangle"></i> ${data.message || 'Error'}</div>`;
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            } catch (e) {
                msg.innerHTML = `<div class="message message-error"><i class="fas fa-wifi"></i> Connection Error</div>`;
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        async function verifyPhoneCode() {
            const btn = document.getElementById('verifyPhoneCodeBtn');
            const code = document.getElementById('phone_code').value;
            const msg = document.getElementById('phoneMessage');
            const lang = localStorage.getItem('selectedLang') || 'uz';

            if (code.length !== 6) {
                msg.innerHTML = `<div class="message message-error"><i class="fas fa-info-circle"></i> ${lang === 'uz' ? '6 ta raqam kiriting' : 'Введите 6 цифр'}</div>`;
                return;
            }

            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch('{% url "public:verify_phone_code" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        phone_number: '{{ participant.phone_number }}',
                        code: code
                    })
                });

                const data = await response.json();

                if (data.success) {
                    msg.innerHTML = `<div class="message message-success"><i class="fas fa-shield-check"></i> ${lang === 'uz' ? 'Tasdiqlandi!' : 'Подтверждено!'}</div>`;
                    if (phoneTimerInterval) clearInterval(phoneTimerInterval);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    msg.innerHTML = `<div class="message message-error"><i class="fas fa-times-circle"></i> ${data.message || 'Error'}</div>`;
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            } catch (e) {
                msg.innerHTML = `<div class="message message-error"><i class="fas fa-wifi"></i> Connection Error</div>`;
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        function startPhoneTimer(seconds) {
            const timerEl = document.getElementById('phoneTimer');
            const btn = document.getElementById('sendPhoneCodeBtn');
            const lang = localStorage.getItem('selectedLang') || 'uz';
            let remaining = seconds;

            timerEl.textContent = (lang === 'uz' ? 'Qayta yuborish: ' : 'Повтор через: ') + remaining + 's';

            phoneTimerInterval = setInterval(() => {
                remaining--;
                if (remaining <= 0) {
                    clearInterval(phoneTimerInterval);
                    timerEl.textContent = '';
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-sync-alt"></i> ${lang === 'uz' ? 'QAYTA YUBORISH' : 'ОТПРАВИТЬ СНОВА'}`;
                } else {
                    timerEl.textContent = (lang === 'uz' ? 'Qayta yuborish: ' : 'Повтор через: ') + remaining + 's';
                }
            }, 1000);
        }

        // Change Password Form
        document.getElementById('changePasswordForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const form = this;
            const msg = document.getElementById('passwordMessage');
            const lang = localStorage.getItem('selectedLang') || 'uz';
            const btn = form.querySelector('button[type="submit"]');

            const currentPassword = form.current_password.value;
            const newPassword = form.new_password.value;
            const confirmPassword = form.confirm_password.value;

            if (newPassword !== confirmPassword) {
                msg.innerHTML = `<div class="message message-error"><i class="fas fa-exclamation-circle"></i> ${lang === 'uz' ? 'Parollar mos kelmadi' : 'Пароли не совпадают'}</div>`;
                return;
            }

            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SAVING...';

            try {
                const response = await fetch('{% url "public:change_password" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    msg.innerHTML = `<div class="message message-success"><i class="fas fa-check-double"></i> ${lang === 'uz' ? 'Parol o\'zgartirildi!' : 'Пароль изменён!'}</div>`;
                    form.reset();
                } else {
                    msg.innerHTML = `<div class="message message-error"><i class="fas fa-times-circle"></i> ${data.message || 'Error'}</div>`;
                }
            } catch (e) {
                msg.innerHTML = `<div class="message message-error"><i class="fas fa-wifi"></i> Connection Error</div>`;
            }

            btn.disabled = false;
            btn.innerHTML = originalHTML;
        });
    </script>
</body>

</html>